# 前端缓存的知识

## http缓存

### 定义： 都是从第二次请求开始，第一次请求资源的时候，服务器返回资源，并在respone header中设置缓存参数，第二次请求的时候：

- 浏览器先根据这个资源的http头信息来判断是否命中强缓存。如果命中则直接加在缓存中的资源，并不会将请求发送到服务器
- 如果未命中强缓存，则浏览器会将资源加载请求发送到服务器。服务器来判断浏览器本地缓存是否失效。若可以使用，则服务器并不会返回资源信息，浏览器继续从缓存加载资源。
- 如果未命中协商缓存，则服务器会将完整的资源返回给浏览器，浏览器加载新资源，并更新缓存

### 局限： 只能缓存get请求

### 强缓存

- Expires

	- 定义： 缓存过期时间，用来指定资源到期的时间，是服务器端的具体的时间点
	- 作用： 在响应http请求时告诉浏览器在过期时间前浏览器可以直接从浏览器缓存取数据，而无需再次请求。
	- 缺点：由于失效时间是一个绝对时间，所以当客户端本地时间被修改以后，服务器与客户端时间偏差变大以后，就会导致缓存混乱。于是发展出了Cache-Control。
	- 优先级： 低

- Cache-Control

	- 定义： 是一个相对时间，由于是相对时间，并且都是与客户端时间比较，所以服务器与客户端时间偏差也不会导致问题。
	-  max-age 

		- 指定一个时间长度，在这个时间段内缓存是有效的，单位是s。

	- s-maxage

		- 同 max-age，覆盖 max-age、Expires，但仅适用于共享缓存，在私有缓存中被忽略

	- public 

		- 表明响应可以被任何对象（发送请求的客户端、代理服务器等等）缓存

	- private 

		- 表明响应只能被单个用户（可能是操作系统用户、浏览器用户）缓存，是非共享的，不能被代理服务器缓存。

	- no-cache

		- 强制所有缓存了该响应的用户，在使用已缓存的数据前，发送带验证器的请求到服务器。不是字面意思上的不缓存。

	- no-store 

		- 禁止缓存，每次请求都要向服务器重新获取数据。

	- must-revalidate

		- 指定如果页面是过期的，则去服务器进行获取。这个指令并不常用，就不做过多的讨论了

- 响应码： 200  size from cache

### 协商缓存

- 定义： 当第一次请求时服务器返回的响应头中没有Cache-Control和Expires或者Cache-Control和Expires过期还或者它的属性设置为no-cache时(即不走强缓存)，那么浏览器第二次请求时就会与服务器进行协商，与服务器端对比判断资源是否进行了修改更新。

	- 如果服务器端的资源没有修改，那么就会返回304状态码，告诉浏览器可以使用缓存中的数据，这样就减少了服务器的数据传输压力。
	- 如果数据有更新就会返回200状态码，服务器就会返回更新后的资源并且将缓存信息一起返回。跟协商缓存相关的header头属性有（ETag/If-Not-Match 、Last-Modified/If-Modified-Since）请求头和响应头需要成对出现

- Last-Modify/If-Modify-Since

	- 浏览器第一次请求一个资源的时候，服务器返回的header中会加上Last-Modify，Last-modify是一个时间标识该资源的最后修改时间
	- 当浏览器再次请求该资源时，发送的请求头中会包含If-Modify-Since，该值为缓存之前返回的Last-Modify。服务器收到If-Modify-Since后，根据资源的最后修改时间判断是否命中缓存
	- 如果命中缓存，则返回http304，并且不会返回资源内容，并且不会返回Last-Modify。由于对比的服务端时间，所以客户端与服务端时间差距不会导致问题。但是有时候通过最后修改时间来判断资源是否修改还是不太准确（资源变化了最后修改时间也可以一致）。于是出现了ETag/If-None-Match。

- ETag/If-None-Match

	- Etag/If-None-Match返回的是一个校验码（ETag: entity tag）。ETag可以保证每一个资源是唯一的，资源变化都会导致ETag变化*。ETag值的变更则说明资源状态已经被修改。服务器根据浏览器上发送的If-None-Match值来判断是否命中缓存

- 由于协商缓存也是需要http请求的，所以一般是尽可能的将静态文件多存储一段时间，多利用强缓存而不是协商缓存

## 浏览器缓存

### 本地缓存

- webStorage

	- sessionStorage
	- localStorage

- cookie
- websql

	- 关系型数据库
	- 被废弃

- indexDB

	- 非关系型数据库
	- 最大容量： 50M

- 应用缓存Application cache
- PWA

	- 实现web网站的APP式的功能与展示
	- 渐进式网络应用

### 默认缓存

- 往返缓存BFCache

	- 浏览器的前进与后退的按钮上提升历史页面的渲染速度的一种策略，BFCache会缓存所有的DOM结构
	- 但是后退后的数据变化，并不能体现在页面上

